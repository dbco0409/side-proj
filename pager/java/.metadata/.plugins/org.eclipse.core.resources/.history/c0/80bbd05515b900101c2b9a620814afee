package com.example.demo.Controller;

import com.example.demo.mapper.ChatMapper;
import com.example.demo.model.Chat;
import com.example.demo.model.User;
import jakarta.servlet.http.HttpSession;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.util.*;

@RestController
@RequestMapping("/api")
public class ApiController {

    private final String API_KEY3 = "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"; // 실제 키 입력
    private final String API_URL3 = "https://api.openai.com/v1/chat/completions";

    private final ChatMapper chatMapper;

    public ApiController(ChatMapper chatMapper) {
        this.chatMapper = chatMapper;
    }

    @PostMapping("/get-solution")
    public Map<String, String> getSolution(@RequestBody Map<String, String> request,
                                           HttpSession session) {

        String question = request.get("question");
        User loginUser = (User) session.getAttribute("loginUser");

        // --- OpenAI API 요청 ---
        Map<String, Object> body = new HashMap<>();
        body.put("model", "gpt-3.5-turbo");
        body.put("messages", List.of(Map.of("role", "user", "content", question)));
        body.put("temperature", 0.7);

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(API_KEY3);

        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(body, headers);
        RestTemplate restTemplate = new RestTemplate();
        ResponseEntity<Map> response = restTemplate.postForEntity(API_URL3, entity, Map.class);

        // --- 응답 파싱 ---
        String answer = "결과 없음";
        try {
            List<Map<String, Object>> choices = (List<Map<String, Object>>) response.getBody().get("choices");
            Map<String, Object> message = (Map<String, Object>) choices.get(0).get("message");
            answer = (String) message.get("content");
        } catch (Exception e) {
            answer = "에러 발생: " + e.getMessage();
        }

        // --- DB 저장 (로그인된 경우만) ---
        if (loginUser != null) {
            String id = loginUser.getMbId();
            String lastGroupId = chatMapper.getLastChatGroupId(id);
            String chatGroupId = (lastGroupId == null) ? 1 +"" : lastGroupId;

            // 질문 저장
            Chat q = new Chat();
            q.setMbId(id);
            q.setChatGroupId(chatGroupId);
            q.setType("Q");
            q.setContent(question);
            chatMapper.insertChat(q);

            // 답변 저장
            Chat a = new Chat();
            a.setMbId(id);
            a.setChatGroupId(chatGroupId);
            a.setType("A");
            a.setContent(answer);
            chatMapper.insertChat(a);
        }

        return Map.of("result", answer);
    }
}
