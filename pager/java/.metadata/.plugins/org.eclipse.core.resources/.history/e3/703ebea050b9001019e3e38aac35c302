package com.pager.Controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.pager.model.User;
import com.pager.service.UserService;

import jakarta.servlet.http.HttpSession;
import lombok.RequiredArgsConstructor;

@Controller
@RequiredArgsConstructor
public class UserController {
	private final UserService userService;
	
	@GetMapping("/login")
    public String showLoginForm() {
        return "login"; // login.html
    }
    
    @PostMapping("/login")
    @ResponseBody
    public Map<String, Object> LoginForm(@RequestParam("mbId") String mbId,
                                         @RequestParam("mbPassword") String mbPassword,
                                         HttpSession session) {
        Map<String, Object> result = new HashMap<>();

        User user = userService.getByMbId(mbId);

        if (user == null || !userService.checkPassword(mbPassword, user.getMbPassword())) {
            result.put("success", false);
            result.put("message", user);
            return result;
        }

        // 세션 저장
        session.setAttribute("loginUser", user);

        UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(user, null, List.of(new SimpleGrantedAuthority("ROLE_ADMIN")));
        SecurityContext context = SecurityContextHolder.createEmptyContext();
        context.setAuthentication(authentication);
        SecurityContextHolder.setContext(context);
        session.setAttribute("SPRING_SECURITY_CONTEXT", context);

        result.put("success", true);
        result.put("redirect", "/");

        return result;
    }
    
    @GetMapping("/register")
    public String showForm() {
        return "register";
    }

    @PostMapping("/register")
    @ResponseBody
    public Map<String, Object> register(@RequestParam("mbId") String mbId,
                                        @RequestParam("mbPassword") String mbPassword,
                                        @RequestParam("mbPasswordRe") String mbPasswordRe,
                                        @RequestParam("mbName") String mbName) {
	    Map<String, Object> result = new HashMap<>();
	    try {
	        if (!mbPassword.equals(mbPasswordRe)) {
	            result.put("success", false);
	            result.put("message", "비밀번호가 일치하지 않습니다.");
	            return result;
	        }
	
	        boolean res = userService.register(mbId, mbPassword, mbName);
	        if (!res) {
	            result.put("success", false);
	            result.put("message", "이미 등록된 이메일입니다.");
	            return result;
	        }
	
	        result.put("success", true);
	        result.put("redirect", "/register_ok");
	    } catch (Exception e) {
	        e.printStackTrace();
	        result.put("success", false);
	        result.put("message", "서버 오류: " + e.getMessage());
	    }
	    return result;
	}
    
    @GetMapping("/register_ok")
    public String registerOk() {
        return "register_ok";
    }
    
    @GetMapping("/forget1")
	public String forget1RequestMethod(HttpSession session) {
    	
    	User loginUser = (User) session.getAttribute("loginUser");
        if (loginUser != null) return "redirect:/mypage";
        
		return "forget1";
	}
    
    @PostMapping("/forget1")
    @ResponseBody
	public Map<String, Object> forget1PostMethod(@RequestParam("mbId") String mbId, @RequestParam("mbName") String mbName, HttpSession session, Model model) {
        
    	Map<String, Object> result = new HashMap<>();
    	try {
    	User user = userService.findByMbId(mbId, mbName);
        if (user == null) {
            result.put("success", false);
            result.put("message", "회원 정보를 찾을 수 없습니다.");
            return result;
        }
    	
        result.put("success", true);
        result.put("redirect", "/forget2?mbid=" + mbId+"&mbName="+mbName);
        
    	} catch (Exception e) {
	        e.printStackTrace();
	        result.put("success", false);
	        result.put("message", "서버 오류: " + e.getMessage());
	    }
	    return result;
	}
    
    @GetMapping("/forget2")
    public String forget2RequestMethod(@RequestParam(value = "mbId", required = false) String mbId, @RequestParam(value = "mbName", required = false) String mbName, 
                                       HttpSession session, Model model) {
    	
    	User loginUser = (User) session.getAttribute("loginUser");
        if (loginUser != null) return "redirect:/mypage";
        
        // ① URL 파라미터로 받은 값 우선
        if (mbId != null) {
            model.addAttribute("mbId", mbId);
            model.addAttribute("mbName", mbName);
        }

        return "forget2"; // forget2.html 렌더링
    }
    
    @PostMapping("/forget2")
    @ResponseBody
	public Map<String, Object> forget2PostMethod(@RequestParam("mbId") String mbId,@RequestParam("mbName") String mbName, @RequestParam("mbPassword") String mbPassword, @RequestParam("mbPasswordRe") String mbPasswordRe, HttpSession session, Model model) {
    	Map<String, Object> result = new HashMap<>();
    	try {
    	User user = userService.findByMbId(mbId, mbName);
        if (user == null) {
            result.put("success", false);
            result.put("message", "회원 정보를 찾을 수 없습니다.");
            return result;
        }
        if (!mbPassword.equals(mbPasswordRe)) {
            result.put("success", false);
            result.put("message", "새 비밀번호가 일치하지 않습니다.");
            return result;
        }
    	
        user.setMbPassword(userService.encodePassword(mbPassword)); // 암호화 필요
        userService.updatePassword(user);
        
        result.put("success", true);
        result.put("redirect", "/login");
        
    	} catch (Exception e) {
	        e.printStackTrace();
	        result.put("success", false);
	        result.put("message", "서버 오류: " + e.getMessage());
	    }
	    return result;
	}


    
    @GetMapping("/edit")
    public String edit(HttpSession session, Model model) {
    	User loginUser = (User) session.getAttribute("loginUser");
        if (loginUser == null) return "redirect:/login";
        model.addAttribute("user", loginUser);
        return "edit";
    }
    
    @PostMapping("/edit")
    public String edit(
            @RequestParam("mbId") String mbId,
            @RequestParam("mbPassword") String mbPassword,          // 현재 비밀번호
            @RequestParam("mbPasswordNew") String mbPasswordNew,   // 새 비밀번호
            @RequestParam("mbPasswordRe") String mbPasswordRe,     // 새 비밀번호 확인
            @RequestParam("mbName") String mbName,                  // 이름
            HttpSession session,
            Model model) {

        User loginUser = (User) session.getAttribute("loginUser");
        if (loginUser == null) return "redirect:/login";

        // DB에서 사용자 조회
        User user = userService.getByMbId(mbId);
        if (user == null) {
            model.addAttribute("error", "회원 정보를 찾을 수 없습니다.");
            return "edit";
        }

        // 현재 비밀번호 일치 확인
        if (!userService.checkPassword(mbPassword, user.getMbPassword())) {
            model.addAttribute("error", "현재 비밀번호가 올바르지 않습니다.");
            return "edit";
        }

        // 새 비밀번호 확인
        if (!mbPasswordNew.equals(mbPasswordRe)) {
            model.addAttribute("error", "새 비밀번호가 일치하지 않습니다.");
            return "edit";
        }

        // --- DB 업데이트 ---
        user.setMbName(mbName);
        user.setMbPassword(userService.encodePassword(mbPasswordNew)); // 암호화 필요
        userService.updateUser(user);

        // 세션 정보 갱신
        session.setAttribute("loginUser", user);

        model.addAttribute("message", "회원정보가 수정되었습니다.");
        return "redirect:/mypage";
    }

    
    @PostMapping("/delete-account")
    @ResponseBody
    public Map<String, Object> deleteAccount(HttpSession session) {
        Map<String, Object> result = new HashMap<>();

        User loginUser = (User) session.getAttribute("loginUser");
        if (loginUser == null) {
            result.put("success", false);
            result.put("message", "로그인이 필요합니다.");
            return result;
        }

        try {
            // ✅ 2. 회원 정보 삭제
            userService.deleteUserByMbId(loginUser.getMbId());

            // ✅ 3. 세션 초기화
            session.invalidate();

            result.put("success", true);
        } catch (Exception e) {
            e.printStackTrace();
            result.put("success", false);
            result.put("message", "탈퇴 중 오류가 발생했습니다.");
        }

        return result;
    }
    
    @GetMapping("/logout")
    public String logout(HttpSession session) {
        session.invalidate(); // 세션 비우기
        return "redirect:/login";
    }
}
